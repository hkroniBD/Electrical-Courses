# üéØ Model Predictive Control (MPC): Complete MATLAB Guide

## Table of Contents
1. [Introduction to MPC](#introduction)
2. [Mathematical Foundation](#mathematical-foundation)
3. [MPC Algorithm](#mpc-algorithm)
4. [MATLAB Implementation Examples](#matlab-implementation)
5. [Advanced Topics](#advanced-topics)
6. [Controller Comparison](#controller-comparison)
7. [When to Use MPC](#when-to-use-mpc)
8. [Real-World Applications](#real-world-applications)
9. [Advantages and Disadvantages](#advantages-and-disadvantages)

---

## 1. Introduction to MPC {#introduction}

### üåü What is Model Predictive Control?

Model Predictive Control (MPC) is an advanced control strategy that uses a mathematical model of the system to predict future behavior and optimize control actions over a finite time horizon. It's like a chess player who thinks several moves ahead before making a decision.

### üèóÔ∏è Core Components

| Component | Description | MATLAB Implementation |
|-----------|-------------|----------------------|
| **üéØ Prediction Model** | Mathematical representation of system dynamics | `ss()`, `tf()`, `c2d()` |
| **üìä Cost Function** | Objective function to be minimized | `Weights` property |
| **‚õìÔ∏è Constraints** | Physical and operational limits | `ManipulatedVariables`, `OutputVariables` |
| **‚è±Ô∏è Horizons** | Prediction and control time windows | `PredictionHorizon`, `ControlHorizon` |

### üîÑ Key Principles

- **üîÆ Predictive Nature**: Uses system models to predict future states
- **‚öñÔ∏è Constraint Handling**: Naturally incorporates constraints
- **üéØ Optimization-Based**: Solves optimization problem at each step
- **üîÑ Receding Horizon**: Continuously updates predictions

---

## 2. Mathematical Foundation {#mathematical-foundation}

### üìê System Model

For linear systems, MPC typically uses state-space representation:

```matlab
% State-space model in MATLAB
A = [1 0.1; 0 0.95];  % State matrix
B = [0; 1];           % Input matrix
C = [1 0];            % Output matrix
D = 0;                % Feedthrough matrix
Ts = 0.1;             % Sample time

% Create discrete-time system
sys = ss(A, B, C, D, Ts);

% Alternative: From transfer function
s = tf('s');
G = 1/(s^2 + 0.5*s + 1);    % Continuous transfer function
Ts = 0.1;
Gd = c2d(G, Ts, 'zoh');     % Convert to discrete-time
```

### üéØ Cost Function

The typical MPC cost function includes tracking error and control effort:

```
J = Œ£[i=1 to Np] ||y(k+i|k) - r(k+i)||¬≤Q + Œ£[i=0 to Nc-1] ||u(k+i|k)||¬≤R

Where:
- Np: prediction horizon
- Nc: control horizon
- Q: output weighting matrix
- R: input weighting matrix
- r(k+i): reference signal
```

### ‚õìÔ∏è Constraints in MATLAB

```matlab
% Input constraints
mpc_obj.ManipulatedVariables.Min = -5;      % Lower bound
mpc_obj.ManipulatedVariables.Max = 5;       % Upper bound
mpc_obj.ManipulatedVariables.RateMin = -2;  % Rate lower bound
mpc_obj.ManipulatedVariables.RateMax = 2;   % Rate upper bound

% Output constraints
mpc_obj.OutputVariables.Min = -10;          % Output lower bound
mpc_obj.OutputVariables.Max = 10;           % Output upper bound
```

---

## 3. MPC Algorithm {#mpc-algorithm}

### üîÑ Step-by-Step Process

1. **üìè Measure Current State**: Obtain x(k) through sensors or estimation
2. **üîÆ Predict Future States**: Use model to predict behavior over Np steps
3. **‚ö° Solve Optimization**: Minimize cost function subject to constraints
4. **üéØ Apply Control**: Implement only first control action u(k)
5. **‚û°Ô∏è Shift Horizon**: Move to next time step and repeat

### ‚è±Ô∏è MATLAB Timing Parameters

| Parameter | MATLAB Property | Typical Range | Impact |
|-----------|----------------|---------------|--------|
| **Prediction Horizon** | `PredictionHorizon` | 10-50 steps | Stability, performance |
| **Control Horizon** | `ControlHorizon` | 2-10 steps | Computational load |
| **Sample Time** | `Ts` | System dependent | Response speed |

---

## 4. MATLAB Implementation Examples {#matlab-implementation}

### üöÄ Basic Linear MPC Example

```matlab
function basic_mpc_example()
    %% System Definition - Mass-Spring-Damper
    % Parameters
    m = 1.0;    % mass (kg)
    k = 1.0;    % spring constant (N/m)
    c = 0.5;    % damping coefficient (N‚ãÖs/m)
    Ts = 0.1;   % sampling time (s)
    
    % Continuous-time state-space model
    % States: [position; velocity]
    % Input: force
    Ac = [0 1; -k/m -c/m];
    Bc = [0; 1/m];
    Cc = [1 0];  % Output: position
    Dc = 0;
    
    % Convert to discrete-time
    sysc = ss(Ac, Bc, Cc, Dc);
    sysd = c2d(sysc, Ts);
    
    %% MPC Controller Design
    mpc_controller = mpc(sysd, Ts);
    
    % Set horizons
    mpc_controller.PredictionHorizon = 20;
    mpc_controller.ControlHorizon = 5;
    
    % Set weights
    mpc_controller.Weights.OutputVariables = 1;           % Q matrix
    mpc_controller.Weights.ManipulatedVariables = 0.1;    % R matrix
    mpc_controller.Weights.ManipulatedVariablesRate = 0.01; % ŒîR matrix
    
    % Set constraints
    mpc_controller.ManipulatedVariables.Min = -5;     % Force limit
    mpc_controller.ManipulatedVariables.Max = 5;
    mpc_controller.OutputVariables.Min = -2;          % Position limit
    mpc_controller.OutputVariables.Max = 2;
    
    %% Simulation Setup
    T_sim = 100;  % Simulation time steps
    
    % Reference signal - step response
    reference = [zeros(20,1); ones(30,1); zeros(50,1)];
    
    % Disturbance signal
    disturbance = zeros(T_sim, 1);
    disturbance(60:70) = 0.5;  % Step disturbance
    
    %% Closed-loop Simulation
    % Method 1: Using sim function
    sim_result = sim(mpc_controller, T_sim, reference, disturbance);
    
    %% Plotting Results
    figure('Name', 'Basic MPC Example', 'Position', [100 100 1000 700]);
    
    subplot(3,1,1);
    plot(1:T_sim, reference, 'r--', 'LineWidth', 2); hold on;
    plot(1:T_sim, sim_result.OutputData, 'b-', 'LineWidth', 2);
    ylabel('Position (m)');
    title('MPC Control Performance');
    legend('Reference', 'Output', 'Location', 'best');
    grid on;
    
    subplot(3,1,2);
    plot(1:T_sim, sim_result.ManipulatedVariablesData, 'g-', 'LineWidth', 2);
    ylabel('Control Force (N)');
    title('Control Input');
    grid on;
    
    subplot(3,1,3);
    plot(1:T_sim, disturbance, 'm-', 'LineWidth', 2);
    ylabel('Disturbance');
    xlabel('Time Step');
    title('External Disturbance');
    grid on;
    
    %% Performance Analysis
    fprintf('=== MPC Performance Analysis ===\n');
    
    % Calculate performance metrics
    tracking_error = reference - sim_result.OutputData;
    ISE = sum(tracking_error.^2);  % Integral Square Error
    IAE = sum(abs(tracking_error)); % Integral Absolute Error
    
    fprintf('Integral Square Error (ISE): %.4f\n', ISE);
    fprintf('Integral Absolute Error (IAE): %.4f\n', IAE);
    
    % Control effort
    control_effort = sum(abs(sim_result.ManipulatedVariablesData));
    fprintf('Total Control Effort: %.4f\n', control_effort);
end
```

### üè≠ Industrial Process Control Example

```matlab
function chemical_reactor_mpc()
    %% Chemical Reactor Model - CSTR (Continuous Stirred Tank Reactor)
    % States: [Concentration; Temperature]
    % Inputs: [Coolant flow rate; Feed concentration]
    % Outputs: [Product concentration; Temperature]
    
    % Linearized model around operating point
    A = [0.95 0.05; 0.02 0.93];
    B = [0.1 0.2; 0.15 0.05];
    C = [1 0; 0 1];  % Both states are measured
    D = zeros(2,2);
    Ts = 1.0;  % 1 second sampling
    
    % Create system
    reactor_sys = ss(A, B, C, D, Ts);
    
    %% Multi-Input Multi-Output MPC Design
    mpc_reactor = mpc(reactor_sys, Ts);
    
    % Horizons
    mpc_reactor.PredictionHorizon = 15;
    mpc_reactor.ControlHorizon = 4;
    
    % Weights - prioritize concentration control
    mpc_reactor.Weights.OutputVariables = [10 1];        % [Conc, Temp]
    mpc_reactor.Weights.ManipulatedVariables = [0.1 0.2]; % [Coolant, Feed]
    mpc_reactor.Weights.ManipulatedVariablesRate = [0.01 0.01];
    
    % Input constraints
    mpc_reactor.ManipulatedVariables(1).Min = 0;    % Coolant flow ‚â• 0
    mpc_reactor.ManipulatedVariables(1).Max = 10;   % Max coolant flow
    mpc_reactor.ManipulatedVariables(2).Min = 0.5;  % Min feed concentration
    mpc_reactor.ManipulatedVariables(2).Max = 2.0;  % Max feed concentration
    
    % Rate constraints
    mpc_reactor.ManipulatedVariables(1).RateMin = -1;
    mpc_reactor.ManipulatedVariables(1).RateMax = 1;
    mpc_reactor.ManipulatedVariables(2).RateMin = -0.1;
    mpc_reactor.ManipulatedVariables(2).RateMax = 0.1;
    
    % Output constraints - safety limits
    mpc_reactor.OutputVariables(1).Min = 0.5;   % Min concentration
    mpc_reactor.OutputVariables(1).Max = 1.5;   % Max concentration
    mpc_reactor.OutputVariables(2).Min = 80;    % Min temperature
    mpc_reactor.OutputVariables(2).Max = 120;   % Max temperature
    
    %% Simulation with Multiple Setpoint Changes
    T_sim = 120;
    
    % Reference trajectories
    conc_ref = [ones(30,1)*1.0; ones(30,1)*1.2; ones(30,1)*0.9; ones(30,1)*1.1];
    temp_ref = [ones(30,1)*100; ones(30,1)*105; ones(30,1)*95; ones(30,1)*102];
    reference = [conc_ref, temp_ref];
    
    % Process disturbances
    dist1 = zeros(T_sim, 1);  % Feed temperature disturbance
    dist1(40:50) = 5;
    dist2 = zeros(T_sim, 1);  % Ambient temperature
    dist2(80:90) = -3;
    disturbance = [dist1, dist2];
    
    %% Run Simulation
    sim_reactor = sim(mpc_reactor, T_sim, reference, disturbance);
    
    %% Advanced Plotting
    figure('Name', 'Chemical Reactor MPC', 'Position', [50 50 1200 800]);
    
    % Outputs
    subplot(2,2,1);
    plot(1:T_sim, reference(:,1), 'r--', 'LineWidth', 2); hold on;
    plot(1:T_sim, sim_reactor.OutputData(:,1), 'b-', 'LineWidth', 2);
    ylabel('Concentration (mol/L)');
    title('Product Concentration Control');
    legend('Setpoint', 'Actual', 'Location', 'best');
    grid on;
    
    subplot(2,2,2);
    plot(1:T_sim, reference(:,2), 'r--', 'LineWidth', 2); hold on;
    plot(1:T_sim, sim_reactor.OutputData(:,2), 'b-', 'LineWidth', 2);
    ylabel('Temperature (¬∞C)');
    title('Reactor Temperature Control');
    legend('Setpoint', 'Actual', 'Location', 'best');
    grid on;
    
    % Control inputs
    subplot(2,2,3);
    plot(1:T_sim, sim_reactor.ManipulatedVariablesData(:,1), 'g-', 'LineWidth', 2);
    ylabel('Coolant Flow (L/min)');
    xlabel('Time (s)');
    title('Coolant Flow Rate');
    grid on;
    
    subplot(2,2,4);
    plot(1:T_sim, sim_reactor.ManipulatedVariablesData(:,2), 'm-', 'LineWidth', 2);
    ylabel('Feed Conc. (mol/L)');
    xlabel('Time (s)');
    title('Feed Concentration');
    grid on;
    
    %% Performance Metrics
    fprintf('\n=== Chemical Reactor MPC Performance ===\n');
    
    % Concentration tracking
    conc_error = reference(:,1) - sim_reactor.OutputData(:,1);
    conc_ISE = sum(conc_error.^2);
    fprintf('Concentration ISE: %.4f\n', conc_ISE);
    
    % Temperature tracking
    temp_error = reference(:,2) - sim_reactor.OutputData(:,2);
    temp_ISE = sum(temp_error.^2);
    fprintf('Temperature ISE: %.4f\n', temp_ISE);
    
    % Constraint violations
    coolant_violations = sum(sim_reactor.ManipulatedVariablesData(:,1) > 10 | ...
                           sim_reactor.ManipulatedVariablesData(:,1) < 0);
    fprintf('Coolant constraint violations: %d\n', coolant_violations);
end
```

### üöó Automotive Cruise Control Example

```matlab
function adaptive_cruise_control_mpc()
    %% Vehicle Dynamics Model
    % Longitudinal vehicle model
    % States: [velocity; position_relative]
    % Input: acceleration
    % Parameters
    m = 1500;      % Vehicle mass (kg)
    f0 = 100;      % Rolling resistance (N)
    f1 = 5;        % Aerodynamic drag coefficient
    f2 = 0.25;     % Aerodynamic drag coefficient
    Ts = 0.1;      % Sample time (s)
    
    % Linearized around cruise speed (20 m/s)
    v_cruise = 20;
    
    % Continuous-time model
    Ac = [-(f1 + 2*f2*v_cruise)/m, 0; 1, 0];
    Bc = [1/m; 0];
    Cc = [1 0; 0 1];  % Both velocity and relative position
    Dc = [0; 0];
    
    % Discretize
    vehicle_sys = ss(Ac, Bc, Cc, Dc);
    vehicle_d = c2d(vehicle_sys, Ts);
    
    %% MPC Controller for ACC
    mpc_acc = mpc(vehicle_d, Ts);
    
    % Horizons - longer for preview capability
    mpc_acc.PredictionHorizon = 25;
    mpc_acc.ControlHorizon = 8;
    
    % Weights
    mpc_acc.Weights.OutputVariables = [1 10];     % [velocity, spacing]
    mpc_acc.Weights.ManipulatedVariables = 0.1;   % Acceleration effort
    mpc_acc.Weights.ManipulatedVariablesRate = 1; % Smooth acceleration
    
    % Physical constraints
    mpc_acc.ManipulatedVariables.Min = -8;        % Max deceleration (m/s¬≤)
    mpc_acc.ManipulatedVariables.Max = 3;         % Max acceleration (m/s¬≤)
    mpc_acc.ManipulatedVariables.RateMin = -5;    % Jerk limits
    mpc_acc.ManipulatedVariables.RateMax = 5;
    
    % Output constraints
    mpc_acc.OutputVariables(1).Min = 0;           % Min velocity
    mpc_acc.OutputVariables(1).Max = 35;          % Max velocity (speed limit)
    mpc_acc.OutputVariables(2).Min = 10;          % Min following distance
    mpc_acc.OutputVariables(2).Max = 100;         % Max spacing considered
    
    %% Simulation Scenario - Highway Driving
    T_sim = 200;  % 20 seconds
    
    % Desired cruise speed and following distance
    v_desired = 25 * ones(T_sim, 1);  % 25 m/s (90 km/h)
    v_desired(100:150) = 20;          % Speed limit reduction
    
    % Safe following distance (time-gap based)
    time_gap = 2.0;  % 2 seconds
    d_desired = v_desired * time_gap;
    
    reference = [v_desired, d_desired];
    
    % Lead vehicle behavior (disturbance)
    lead_decel = zeros(T_sim, 1);
    lead_decel(80:120) = -2;    % Lead vehicle brakes
    lead_decel(140:160) = -4;   % Emergency braking
    
    disturbance = [zeros(T_sim,1), lead_decel];
    
    %% Simulation with Safety Features
    sim_acc = sim(mpc_acc, T_sim, reference, disturbance);
    
    %% Visualization
    figure('Name', 'Adaptive Cruise Control MPC', 'Position', [100 100 1200 900]);
    
    % Vehicle speed
    subplot(2,2,1);
    plot(1:T_sim, reference(:,1)*3.6, 'r--', 'LineWidth', 2); hold on;
    plot(1:T_sim, sim_acc.OutputData(:,1)*3.6, 'b-', 'LineWidth', 2);
    ylabel('Speed (km/h)');
    title('Vehicle Speed Control');
    legend('Desired', 'Actual', 'Location', 'best');
    grid on;
    
    % Following distance
    subplot(2,2,2);
    plot(1:T_sim, reference(:,2), 'r--', 'LineWidth', 2); hold on;
    plot(1:T_sim, sim_acc.OutputData(:,2), 'b-', 'LineWidth', 2);
    plot(1:T_sim, ones(T_sim,1)*10, 'k:', 'LineWidth', 1);  % Safety limit
    ylabel('Following Distance (m)');
    title('Safe Following Distance');
    legend('Desired', 'Actual', 'Safety Limit', 'Location', 'best');
    grid on;
    
    % Acceleration profile
    subplot(2,2,3);
    plot(1:T_sim, sim_acc.ManipulatedVariablesData, 'g-', 'LineWidth', 2);
    ylabel('Acceleration (m/s¬≤)');
    xlabel('Time Step (0.1s)');
    title('Vehicle Acceleration');
    grid on;
    
    % Safety analysis
    subplot(2,2,4);
    time_to_collision = sim_acc.OutputData(:,2) ./ max(sim_acc.OutputData(:,1), 1);
    plot(1:T_sim, time_to_collision, 'r-', 'LineWidth', 2); hold on;
    plot(1:T_sim, ones(T_sim,1)*2, 'k--', 'LineWidth', 2);  % Safety threshold
    ylabel('Time to Collision (s)');
    xlabel('Time Step (0.1s)');
    title('Safety Metric');
    legend('TTC', 'Safety Threshold', 'Location', 'best');
    grid on;
    
    %% Safety Assessment
    fprintf('\n=== Adaptive Cruise Control Performance ===\n');
    
    % Comfort metrics
    max_accel = max(sim_acc.ManipulatedVariablesData);
    max_decel = min(sim_acc.ManipulatedVariablesData);
    jerk = diff(sim_acc.ManipulatedVariablesData) / Ts;
    max_jerk = max(abs(jerk));
    
    fprintf('Maximum acceleration: %.2f m/s¬≤\n', max_accel);
    fprintf('Maximum deceleration: %.2f m/s¬≤\n', max_decel);
    fprintf('Maximum jerk: %.2f m/s¬≥\n', max_jerk);
    
    % Safety metrics
    min_distance = min(sim_acc.OutputData(:,2));
    safety_violations = sum(sim_acc.OutputData(:,2) < 10);
    
    fprintf('Minimum following distance: %.2f m\n', min_distance);
    fprintf('Safety violations: %d time steps\n', safety_violations);
end
```

### üè¢ Building HVAC System Example

```matlab
function building_hvac_mpc()
    %% Building Thermal Model
    % Multi-zone building with thermal coupling
    % States: [T_zone1; T_zone2; T_wall]
    % Inputs: [Q_hvac1; Q_hvac2] (heating/cooling power)
    % Disturbances: [T_ambient; Solar_gain; Occupancy]
    
    % Thermal parameters
    C1 = 1e6;      % Zone 1 thermal capacity (J/K)
    C2 = 1.2e6;    % Zone 2 thermal capacity (J/K)
    Cw = 2e6;      % Wall thermal capacity (J/K)
    R12 = 0.01;    % Thermal resistance zone1-zone2 (K/W)
    R1w = 0.005;   % Thermal resistance zone1-wall (K/W)
    R2w = 0.005;   % Thermal resistance zone2-wall (K/W)
    Rout = 0.002;  % Thermal resistance to ambient (K/W)
    
    Ts = 300;      % 5-minute sampling (300 seconds)
    
    % Continuous-time model
    Ac = [-1/(C1*(R12+R1w)), 1/(C1*R12), 1/(C1*R1w);
          1/(C2*R12), -1/(C2*(R12+R2w)), 1/(C2*R2w);
          1/(Cw*R1w), 1/(Cw*R2w), -1/(Cw*(R1w+R2w+Rout))];
    
    Bc = [1/C1, 0;           % HVAC inputs
          0, 1/C2;
          0, 0];
    
    Bd = [1/(C1*R12), 0, 1/C1;        % Disturbance inputs
          1/(C2*R12), 0, 1/C2;        % [T_ambient, Solar, Occupancy]
          1/(Cw*Rout), 1/Cw, 0];
    
    Cc = eye(3);  % All temperatures measured
    Dc = zeros(3,2);
    
    % Create system with disturbances
    hvac_sys = ss(Ac, [Bc Bd], Cc, [Dc zeros(3,3)]);
    hvac_d = c2d(hvac_sys, Ts);
    
    % Extract control system (without disturbances for MPC design)
    hvac_control = ss(hvac_d.A, hvac_d.B(:,1:2), hvac_d.C, hvac_d.D(:,1:2), Ts);
    
    %% Economic MPC for Energy Optimization
    mpc_hvac = mpc(hvac_control, Ts);
    
    % Horizons - long for energy optimization
    mpc_hvac.PredictionHorizon = 48;  % 4 hours ahead
    mpc_hvac.ControlHorizon = 12;     % 1 hour control
    
    % Time-varying weights for energy pricing
    base_weight = 0.1;
    mpc_hvac.Weights.OutputVariables = [10 10 1];      % Zone temperatures priority
    mpc_hvac.Weights.ManipulatedVariables = [base_weight base_weight];
    mpc_hvac.Weights.ManipulatedVariablesRate = [0.01 0.01];
    
    % HVAC capacity constraints
    mpc_hvac.ManipulatedVariables(1).Min = -5000;  % Max cooling (W)
    mpc_hvac.ManipulatedVariables(1).Max = 3000;   % Max heating (W)
    mpc_hvac.ManipulatedVariables(2).Min = -4000;
    mpc_hvac.ManipulatedVariables(2).Max = 3500;
    
    % Comfort constraints
    mpc_hvac.OutputVariables(1).Min = 20;     % Zone 1 temp limits (¬∞C)
    mpc_hvac.OutputVariables(1).Max = 26;
    mpc_hvac.OutputVariables(2).Min = 18;     % Zone 2 temp limits
    mpc_hvac.OutputVariables(2).Max = 25;
    mpc_hvac.OutputVariables(3).Min = 15;     % Wall temp limits
    mpc_hvac.OutputVariables(3).Max = 30;
    
    %% Simulation with Weather and Occupancy
    T_sim = 96;  % 8 hours (48 time steps √ó 5 min)
    
    % Comfort setpoints with schedules
    T1_setpoint = 22 * ones(T_sim, 1);  % Zone 1: Office
    T1_setpoint(1:8) = 18;               % Night setback
    T1_setpoint(80:96) = 18;             % Evening setback
    
    T2_setpoint = 21 * ones(T_sim, 1);  % Zone 2: Conference room
    T2_setpoint(1:16) = 18;              % Unoccupied morning
    T2_setpoint(64:96) = 19;             % Reduced evening
    
    % Wall temperature not controlled directly
    Tw_setpoint = 22 * ones(T_sim, 1);
    
    reference = [T1_setpoint, T2_setpoint, Tw_setpoint];
    
    % Environmental disturbances
    time_hrs = (1:T_sim) * Ts / 3600;  % Time in hours
    
    % Ambient temperature (daily cycle)
    T_ambient = 15 + 8*sin(2*pi*(time_hrs-6)/24);  % Daily temperature cycle
    
    % Solar gain (peak at noon)
    solar_gain = 1000 * max(0, sin(pi*(time_hrs-6)/12));
    
    % Occupancy schedule
    occupancy = zeros(T_sim, 1);
    occupancy(16:64) = 500;  % 500W heat gain during work hours
    occupancy(32:48) = 800; % Higher occupancy midday
    
    disturbance = [T_ambient', solar_gain', occupancy];
    
    %% Advanced Simulation with Disturbance Model
    % Create augmented system for simulation including disturbances
    x0 = [22; 21; 22];  % Initial temperatures
    
    % Manual simulation to include disturbances properly
    x = x0;
    y_sim = [];
    u_sim = [];
    
    for k = 1:T_sim
        % Current reference
        r_current = reference(k:min(k+mpc_hvac.PredictionHorizon-1, T_sim), :);
        if size(r_current,1) < mpc_hvac.PredictionHorizon
            r_current = [r_current; repmat(r_current(end,:), ...
                        mpc_hvac.PredictionHorizon - size(r_current,1), 1)];
        end
        
        % Solve MPC
        u_opt = mpcmove(mpc_hvac, [], x, r_current, []);
        
        % Apply control with disturbances
        x = hvac_d.A * x + hvac_d.B(:,1:2) * u_opt + hvac_d.B(:,3:5) * disturbance(k,:)';
        y = hvac_d.C * x;
        
        % Store results
        y_sim = [y_sim; y'];
        u_sim = [u_sim; u_opt'];
    end
    
    %% Results Visualization
    figure('Name', 'Building HVAC MPC', 'Position', [50 50 1400 1000]);
    
    % Zone temperatures
    subplot(3,2,1);
    plot(time_hrs, reference(:,1), 'r--', 'LineWidth', 2); hold on;
    plot(time_hrs, y_sim(:,1), 'b-', 'LineWidth', 2);
    ylabel('Zone 1 Temp (¬∞C)');
    title('Zone 1 Temperature Control');
    legend('Setpoint', 'Actual', 'Location', 'best');
    grid on;
    
    subplot(3,2,2);
    plot(time_hrs, reference(:,2), 'r--', 'LineWidth', 2); hold on;
    plot(
